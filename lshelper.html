<!DOCTYPE html>
<html lang="en">
  <head>
    <title>"LN0LSync 1.0" a Lyrics synchronizing tool written in HTML, CSS and JavaScript</title>
    <meta charset="utf-8"/>
    <meta name="Web-Developer" content="LineNumber0"/>							<!-- Benlamine Abdelmourhit -->
    <meta name="Date" content="Tuesday 01-January-2019 20:31 +01"/>
    <link id="lslink" rel="stylesheet" href="styles/followLyrics.css"/>					<!-- the Hcode() function will always get every element with its id, regardless of the source code changes. -->
    <style type="text/css">
      body {
      background-image: url(ext/msc.png);
      }
      #pcode {
      position:fixed;
      bottom:182px;
      left: 10px;
      width:98%;
      height:25%;
      font-size:initial;
      font-family:monospace;
      background-color:black;
      color:white;
      margin-bottom:10px;
      }
      #hlpcnt {
      position:fixed;
      bottom:152px;
      font-size:initial;
      }
      button {
      margin: 0 32px -8px 8px;
      padding: 8px;
      font-weight:bold;
      }
      #outerh:hover ~ #hlpcnt, #audplayer:hover ~ #hlpcnt {opacity:0.1;transition:5s} #hlpcnt {opacity:1;transition:0.5s}
      *[class^="swal"] {													/* swal library elements */
      text-shadow:none;
      font-weight:bold;
      }
      #ht,#outerh {
      background-color:white;
      display: inline-block;
      padding:16px;
      }
      </style>
  </head>
  <body>
  <h1 id="ht">Develop a Lyrics Synchronizer !</h1>
  <div id="outerh">
  </div>
  <audio id="audplayer" controls="yes" loop="yes" title="" >
    <source />
  </audio>
  <div id="hlpcnt">
    <textarea id="pcode" placeholder="Paste your Lyrics here" spellcheck="false" onpaste="ldisplay()" onfocus="ldisplay()" ></textarea>
    <button id="addfile" onclick="AddAudioFile()" >Add audio file</button>
    <button id="gcode" onclick="Hcode()" >Get HTML code</button>
    <button id="clearc" onclick="confirmReset()" >Clear</button>
    <button id="svcd" onclick="saveNchk()" >Save to HTML file</button>
  </div>
<script type="text/javascript">
  var textarea = document.getElementById("pcode"),
  nlineRX = /\n\n+/gm,
  spRX = /%20/g,
  htmlRX = /<\/?\w+((\s+\w+(\s*=\s*(?:".*?"|'.*?'|[\^'">\s]+))?)+\s*|\s*)\/?>/gmi,
  tmpidRX = /\sid=('|")[a-z0-9]+('|")/i,
  lsarryRX = /LyricTimes = \[([0-9]{1,}\,?)+\]\;/g,
  lcont = document.getElementById("outerh"),
  uicnt = document.getElementById("hlpcnt"),
  audsrc = audplayer.firstElementChild;
  
  function confirmReset() {                                 
  if (confirm("Are you sure to reset the text field ?")) { 
  textarea.value = "";                                           
  } else {
  return;                                          
    }
  }
  
  function AddAudioFile() {
  if (textarea.value == "" || !nlineRX.test(textarea.value)) {
  swal("","Paste your Lyrics first !","error");
  } else {
  var audfile = prompt("\n\nPaste the Link or URL of the audio file\n\nWith extension, (example : https://foo.bar/link/to/myfile.mp3)\n\n","");
  if (audfile == "" || audfile == null) {
  return;
  } else {
  audsrc.src = audfile;
  audsrc.type = "audio/" + audfile.substring(audfile.lastIndexOf(".") + 1);
  audplayer.load();
  setTimeout(function(){												// give the audio player some time to load before evaluation !
  if (!audplayer.duration) {
  if (audplayer.canPlayType('audio/mp3') == "" && (audsrc.type == "audio/mp3" || audsrc.type == "audio/mpeg")) {
  swal("ERROR !","This browser cannot play MP3 format !\n\nTry another format !\n\n","error");
  } else {
  swal("File not loaded !","Try again !","error");
  }
  } else {
  swal("","File loaded successfully !","success");
  setTimeout(function(){
  swal("Now play your audio file and pause to save Lyrics positions !");
  },3000);
  } 
  },500);
   }
  }
  }
  
  function ldisplay() {
  setTimeout(function() {
  if (nlineRX.test(textarea.value) && !htmlRX.test(textarea.value)) {
  lcont.innerHTML =  "<pre>" + textarea.value + "</pre>";
  ht.style.display = "none";
  }
  },500);
  }
  
  function recStimes() {
  var pStime;
  do {
  pStime = prompt("Do you want to save this position ?",getStime());
  } while (pStime != getStime() && pStime != null);
  if (pStime == null) {
  return;
  } else {
  LyricTimes.push(pStime);
  }
  return lsarray.innerHTML = "LyricTimes = [" + LyricTimes + "];";
  }
  audplayer.addEventListener("pause",recStimes);
  
  function setElink(element) {
  if (document.location.href === "https://linenumber0.github.io/lshelper.html") {
  element.src ? element.src = element.src : element.href = element.href;
  return element.outerHTML.replace(tmpidRX,"");
  } else {
  return element.outerHTML.replace(tmpidRX,"");
  }
  }
  
  function Hcode() {
  if (audsrc.src == "") {
  swal("","Add an audio file !","error");
  } else if (LyricTimes.length == 0 && nlineRX.test(textarea.value)) {
  swal("Now play your audio file and pause to save Lyrics positions !");
  } else {
  var NewTextArea,
  stCount = 1;
  if (nlineRX.test(textarea.value) && !htmlRX.test(textarea.value)) {
  NewTextArea = textarea.value.replace(nlineRX, function() {
  return "\n\n\n</pre>\n<a id='lp" + stCount++ + "'></a>\n<pre>\n";
  });
  var FinalTextArea = "<a id='lp0" + "'></a>\n<pre>\n" + NewTextArea + "\n</pre>\n",
  stitle = audsrc.src.substring(audsrc.src.lastIndexOf("/") + 1,audsrc.src.lastIndexOf(".")),
  fileName = stitle.replace(spRX," ");
  textarea.value = "<!DOCTYPE html>\n<html>\n<head>\n<meta charset='utf-8'/>\n<title>" + fileName + "</title>\n" + setElink(lslink) + "\n</head>\n<body>\n<h1>" + fileName + "</h1>\n" + FinalTextArea + audplayer.outerHTML + "\n" + setElink(lsscript) + "\n" + setElink(lsarray) + "\n</body>\n</html>";
  textarea.select();
  document.execCommand('copy');
  swal("","The HTML code is pasted into your clipboard !","success");
  } else if (htmlRX.test(textarea.value)) {
  textarea.value = textarea.value.replace(lsarryRX,"LyricTimes = [" + LyricTimes + "];");
  } else {
  swal("Paste your Lyrics in form of : ","\n\nLorem ipsum dolor sit amet,\nconsectetaur adipisicing elit,\nsed do eiusmod tempor incididunt ut labore et dolore magna aliqua.\n\nUt enim ad minim veniam,\nquis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.\n\nDuis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.\n\nExcepteur sint occaecat cupidatat non proident,\nsunt in culpa qui officia deserunt mollit anim id est laborum.\n\nLorem ipsum dolor sit amet,\nconsectetaur adipisicing elit,\nsed do eiusmod tempor incididunt ut labore et dolore magna aliqua.\n\nUt enim ad minim veniam,\nquis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.\n\nDuis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.\n\nExcepteur sint occaecat cupidatat non proident,\nsunt in culpa qui officia deserunt mollit anim id est laborum.\n\n");
  }
   }
  }
  // TODO replace all JavaScript standard confirm and prompt with swal dialogs.
</script>
<script id="lsscript" src="JS/followLyrics.js" charset="utf-8"></script>
  <script id="lsarray">
    </script>
    <script src="JS/FileSaver.min.js" charset="utf-8"></script>
    <script type="text/javascript">
      function saveNchk() {
      var html = textarea.value + "\n<!-- Exported using LN0LSync 1.0 at https://linenumber0.github.io/lshelper.html -->";
      var blobfilename = audsrc.src.substring(audsrc.src.lastIndexOf("/") + 1,audsrc.src.lastIndexOf("."));
      var blob = new Blob([html], {type: "text/html"});
      if (!htmlRX.test(html)) {
      swal("","There is no HTML code in the text field !","error");
      } else {
      if (LyricTimes.length != textarea.value.match(nlineRX).length + 1) {
      confirm("The number of Lyrics sections doesn't match the number of saved positions !\n\nDo you want to continue (OK) or restart (CANCEL) ?\n\n") ? saveAs(blob, blobfilename.replace(spRX,"-") + ".html") : (function() { audplayer.load(); LyricTimes = []; })();
      } else {
      saveAs(blob, blobfilename.replace(spRX,"-") + ".html");
       }
      }
      }
    </script>
    <script src="JS/sweetalert.min.js"></script>
    <noscript>
      <style type="text/css">
	body *:not(noscript) {
	display:none;
	}
      </style>
      Please activate javascript in your browser to use this page !
      </noscript>
  </body>
</html>